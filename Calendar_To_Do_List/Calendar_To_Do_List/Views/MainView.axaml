<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Calendar_To_Do_List.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="Calendar_To_Do_List.Views.MainView"
             x:DataType="vm:MainViewModel">
  <UserControl.Styles>
    <Style Selector="TextBlock.done">
      <Setter Property="TextDecorations" Value="{DynamicResource SystemControlDisabledBaseMediumLowBrush}"/>
      <Setter Property="Foreground" Value="Gray"/>
    </Style>

    <Style Selector="Border#SidebarBorder">
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Width" Duration="0:0:0.3" Easing="QuarticEaseOut"/>
        </Transitions>
      </Setter>
    </Style>

    <Style Selector="Button:pointerover /template/ ContentPresenter">
      <Setter Property="Background" Value="#f0f0f0" />
    </Style>
  </UserControl.Styles>

  <Design.DataContext>
    <vm:MainViewModel/>
  </Design.DataContext>

  <Grid ColumnDefinitions="Auto,*">

     <!-- 【左侧导航栏】 -->
    <Border x:Name="SidebarContainer" 
            Grid.Column="0"
            ClipToBounds="True"
            Background="{DynamicResource SidebarBackground}" 
            BorderBrush="{DynamicResource SeparatorColor}" 
            BorderThickness="0,0,1,0"
            Width="{Binding SidebarWidth}"> 
      
      <Grid RowDefinitions="Auto, *, Auto" ClipToBounds="True">
        <!-- 顶部汉堡按钮 -->
        <Button Grid.Row="0" Command="{Binding ToggleSidebarCommand}" Background="{DynamicResource SidebarBackground}">
          <TextBlock Text="≡" FontSize="20" FontWeight="Bold" Foreground="#2564cf"/>
        </Button>

        <!-- 导航分类 -->
        <StackPanel Grid.Row="1">
          <TextBlock Text="CalenderToDoList" Margin="15,20,0,20" FontWeight="Bold" Foreground="#2564cf" FontSize="26"/>
          <ListBox Background="{DynamicResource SystemRegionBrush}" BorderThickness="0">
            <ListBoxItem Content="任务" Padding="30,12" IsSelected="True"/>
          </ListBox>
        </StackPanel>

        <StackPanel Grid.Row="2">
          <Button HorizontalAlignment="Stretch" HorizontalContentAlignment="Left" Background="{DynamicResource SidebarBackground}" Padding="10,8" Command="{Binding ExportIcsCommand}">
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="📅" Margin="0,0,10,0"/>
              <TextBlock Text="导出为 .ics 文件" VerticalAlignment="Center" FontSize="14"/>
            </StackPanel>
          </Button>

          <Button HorizontalAlignment="Stretch" HorizontalContentAlignment="Left" Background="{DynamicResource SidebarBackground}" Padding="10,8" Foreground="#d13438" Command="{Binding ExitAppCommand}">
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="🚪" Margin="0,0,10,0"/>
              <TextBlock Text="退出程序" VerticalAlignment="Center" FontSize="14"/>
            </StackPanel>
          </Button>

         <Button HorizontalAlignment="Stretch" 
                 Background="Transparent" 
                 Command="{Binding ToggleThemeCommand}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="🌓" Margin="0,0,10,0"/>
                <TextBlock Text="切换主题模式" VerticalAlignment="Center"/>
            </StackPanel>
          </Button>

        </StackPanel>
      </Grid>
    </Border>

    <!-- 右侧主内容区 -->
    <Border Grid.Column="1" Background="{DynamicResource MainBackground}" Padding="30,50,30,20">
      <Grid RowDefinitions="Auto, *, Auto">
        <TextBlock Grid.Row="0" Text="待办清单" FontSize="24" FontWeight="SemiBold" Foreground="#2564cf" Margin="0,0,0,20"/>

        <!-- 任务列表 -->
        <ScrollViewer Grid.Row="1">
          <ItemsControl ItemsSource="{Binding TodoItems}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="{DynamicResource CardBackground}" CornerRadius="5" Margin="0,0,0,5" BoxShadow="0 1 3 0 #40000000">
                  <Grid ColumnDefinitions="Auto, *" Margin="10">
                    <CheckBox Grid.Column="0" IsChecked="{Binding IsCompleted}" Classes.done="{Binding IsCompleted}" VerticalAlignment="Center"/>

                    <!-- 【修改点 1】使用 StackPanel 实现文字在上，日期在下 -->
                    <StackPanel Grid.Column="1" Margin="10,0" VerticalAlignment="Center">
                      <!-- 任务内容 -->
                      <TextBlock Text="{Binding Description}" FontSize="16" FontWeight="Normal"/>
                      <!-- 日期信息：字号更小，颜色为灰色，仅在有日期时显示 -->
                      <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                  IsVisible="{Binding Due, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Text="📅" FontSize="10" Foreground="{DynamicResource MainText}" Margin="0,0,5,0" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding Due, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                   FontSize="12"
                                   Foreground="{DynamicResource MainText}"
                                   VerticalAlignment="Center"/>
                      </StackPanel>
                    </StackPanel>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <!-- 底部输入框 -->
        <Border Grid.Row="2" Background="{DynamicResource CardBackground}" CornerRadius="5" Padding="5" Margin="0,10,0,0">
          <Grid ColumnDefinitions="*, Auto, Auto, Auto,Auto">

            <!-- 【修改点 2】TextBox 独立出来，不再包裹其他控件 -->
            <TextBox Grid.Column="0"
                     Text="{Binding NewTaskContent}"
                     Watermark="添加任务"
                     BorderThickness="0"
                     VerticalContentAlignment="Center"
                     Background="Transparent">
              <TextBox.KeyBindings>
                <KeyBinding Gesture="Enter" Command="{Binding AddTaskCommand}" />
              </TextBox.KeyBindings>
            </TextBox>

            <!-- 【修改点 3】DatePicker 放在 TextBox 后面，占独立的一列 -->
            <CalendarDatePicker Grid.Column="1"
                                SelectedDate="{Binding NewTaskDate}"
                                Watermark="截止日期"
                                BorderThickness="0"
                                Background="Transparent"
                                VerticalAlignment="Center"
                                Margin="5,0"/>

            <TimePicker Grid.Column="2" 
                        SelectedTime="{Binding NewTaskTime}"
                        ClockIdentifier="24HourClock"
                        BorderThickness="0"
                        Background="Transparent"
                        VerticalAlignment="Center"
                        Margin="5,0"/>

            <Button Grid.Column="3"
                    Command="{Binding DeleteLastTaskCommand}"
                    Background="Transparent"
                    BorderThickness="0"
                    Width="35" Height="35"
                    Padding="0"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"
                    VerticalAlignment="Center">
              <TextBlock Text="🗑️" FontSize="16" Foreground="#d13438" HorizontalAlignment="Center"/>
            </Button>

            <Button Grid.Column="4"
                    Command="{Binding AddTaskCommand}"
                    Background="Transparent"
                    BorderThickness="0"
                    Width="35" Height="35"
                    VerticalAlignment="Center">
              <TextBlock Text="+" FontSize="20" FontWeight="Bold" Foreground="#2564cf" HorizontalAlignment="Center"/>
            </Button>
          </Grid>
        </Border>
      </Grid>
    </Border>
  </Grid>
</UserControl>